# GNU Make solution makefile autogenerated by Premake
# Type "make help" for usage help

ifndef config
  config=debug
endif
export config

ifeq ($(config),debug)
  OBJDIR     = obj/Release/RecastDemo
  TARGETDIR  = ../RecastDemo/Bin
  TARGETLIB  = lib/Debug
#  TARGETDIR  = lib/Release
  TARGET     = $(TARGETDIR)/RecastDemod
  CPPFLAGS  += -MMD -MP $(DEFINES) $(INCLUDES)
  CFLAGS    += $(CPPFLAGS) $(ARCH) -Wall -ffast-math -O2 -g
  CXXFLAGS  += $(CFLAGS) 
  ALL_ARCHIVES = -L$(TARGETLIB) -lRecastDemoBis -lDebugUtils -lDetourCrowd -lDetourTileCache -lDetour -lRecast
endif

ifeq ($(config),release)
  OBJDIR     = obj/Release/RecastDemo
  TARGETDIR  = ../RecastDemo/Bin
  TARGETLIB  = lib/Release
#  TARGETDIR  = lib/Release
  TARGET     = $(TARGETDIR)/RecastDemo
  CPPFLAGS  += -MMD -MP $(DEFINES) $(INCLUDES)
  CFLAGS    += $(CPPFLAGS) $(ARCH) -Wall -ffast-math -O4
  CXXFLAGS  += $(CFLAGS) -fno-exceptions -fno-rtti
  ALL_ARCHIVES = -L$(TARGETLIB) -lRecastDemoBis -lDebugUtils -lDetourCrowd -lDetourTileCache -lDetour -lRecast
endif
  
RECAST_INC=-I../Recast/Include
DETOUR_INC=-I../Detour/Include -I../DetourCrowd/Include -I../DetourTileCache/Include
DEBUG_INC=-I../DebugUtils/Include
#DEMO_INC=-I../RecastDemo/Include -I../RecastDemo/Contrib/fastlz
DEMO_INC=-I./demo

RECAST_DEMO_SOURCE=./demo


ALL_INCS=${RECAST_INC} ${DETOUR_INC} ${DEBUG_INC} ${DEMO_INC} -I.

PROJECTS := DebugUtils Detour DetourCrowd DetourTileCache Recast RecastDemo

.PHONY: all clean help 
#$(PROJECTS)

all: build/Recast.swc

build/Recast_wrap.o: recast.i $(PROJECTS)
	
	#swig from recast.i file
	# Generate the SWIG wrappers
	swig -as3 -package org.recastnavigation -c++ $(ALL_INCS) -module Recast recast.i
#	&> build/swig.log
	mv Recast_wrap.cxx build
	mv Recast.as build
	
	# Compile the SWIG AS3 wrappers
	java -jar "C:\Crossbridge\sdk\usr\lib\asc2.jar" -import "C:\Crossbridge\sdk\usr\lib\builtin.abc" -import "C:\Crossbridge\sdk\usr\lib\playerglobal.abc" build/Recast.as

	# Compile the SWIG C++ wrappers
	g++ $(BASE_CFLAGS) $(CFLAGS) $(ALL_INCS) build/Recast_wrap.cxx -c &> build/swig_wrapper.log
	mv Recast_wrap.o build

	# protect the required symbols in the LTO exports file
	#cp -f exports.txt build/
	#chmod u+rw build/exports.txt
	#nm build/Recast_wrap.o | grep " T " | awk '{print $$3}' | sed 's/__/_/' >> build/exports.txt

build/Recast.swc: build/Recast_wrap.o $(PROJECTS) $(TARGETLIB)/libRecastDemoBis.a

	# Link the final library
	g++ -jvmopt=-Xmx1G $(BASE_CFLAGS) $(ALL_INCS) swigmain.cpp \
	./build/Recast_wrap.o ./build/Recast.abc \
	-Wl,--start-group \
	-Wl,--end-group \
	-emit-swc=org.recastnavigation $(CFLAGS) $(EXTRA_OPTS) $(ALL_ARCHIVES) -lGL -swf-version=17 -o build/Recast.swc # &> build/swc.log
	#-fllvm-llc-opt=-ascopt=-optimize -fllvm-llc-opt=-ascopt=-removedeadcode  \
	#-emit-swc=org.recastnavigation $(CFLAGS) -flto-api=build/exports.txt $(EXTRA_OPTS) -o build/Recast.swc &> build/swc.log #with -flto option
	#-fllvm-llc-opt=-ascopt=-load-config+=airmobile-config.xml \
	
DebugUtils: 
	@echo "==== Building DebugUtils ($(config)) ===="
	@${MAKE} --no-print-directory -C . -f DebugUtils.make

Detour: 
	@echo "==== Building Detour ($(config)) ===="
	@${MAKE} --no-print-directory -C . -f Detour.make

DetourCrowd: 
	@echo "==== Building DetourCrowd ($(config)) ===="
	@${MAKE} --no-print-directory -C . -f DetourCrowd.make

DetourTileCache: 
	@echo "==== Building DetourTileCache ($(config)) ===="
	@${MAKE} --no-print-directory -C . -f DetourTileCache.make

Recast: 
	@echo "==== Building Recast ($(config)) ===="
	@${MAKE} --no-print-directory -C . -f Recast.make

RecastDemo: DebugUtils Detour DetourCrowd DetourTileCache Recast
	@echo "==== Building RecastDemo ($(config)) ===="
	@${MAKE} --no-print-directory -C . -f RecastDemo.make

clean:
	@${MAKE} --no-print-directory -C . -f DebugUtils.make clean
	@${MAKE} --no-print-directory -C . -f Detour.make clean
	@${MAKE} --no-print-directory -C . -f DetourCrowd.make clean
	@${MAKE} --no-print-directory -C . -f DetourTileCache.make clean
	@${MAKE} --no-print-directory -C . -f Recast.make clean
	@${MAKE} --no-print-directory -C . -f RecastDemo.make clean

help:
	@echo "Usage: make [config=name] [target]"
	@echo ""
	@echo "CONFIGURATIONS:"
	@echo "   debug"
	@echo "   release"
	@echo "   debug32"
	@echo "   release32"
	@echo ""
	@echo "TARGETS:"
	@echo "   all (default)"
	@echo "   clean"
	@echo "   DebugUtils"
	@echo "   Detour"
	@echo "   DetourCrowd"
	@echo "   DetourTileCache"
	@echo "   Recast"
	@echo "   RecastDemo"
	@echo ""
	@echo "For more information, see http://industriousone.com/premake/quick-start"
	
$(TARGETLIB)/libRecastDemoBis.a: ${RECAST_DEMO_SOURCE}/ChunkyTriMesh.cpp ${RECAST_DEMO_SOURCE}/MeshLoaderObj.cpp ${RECAST_DEMO_SOURCE}/InputGeom.cpp ${RECAST_DEMO_SOURCE}/Sample.cpp ${RECAST_DEMO_SOURCE}/SoloMesh.cpp ${RECAST_DEMO_SOURCE}/fastlz.c ${RECAST_DEMO_SOURCE}/Sample_TempObstacles.cpp
	g++ $(CXXFLAGS) -c ${RECAST_INC} ${DEMO_INC} -o ${OBJDIR}/ChunkyTriMesh.o ${RECAST_DEMO_SOURCE}/ChunkyTriMesh.cpp
	g++ $(CXXFLAGS) -c ${RECAST_INC} ${DEMO_INC} -o ${OBJDIR}/MeshLoaderObj.o ${RECAST_DEMO_SOURCE}/MeshLoaderObj.cpp
	g++ $(CXXFLAGS) -c ${ALL_INCS} -o ${OBJDIR}/InputGeom.o ${RECAST_DEMO_SOURCE}/InputGeom.cpp
	g++ $(CXXFLAGS) -c ${ALL_INCS} -o ${OBJDIR}/Sample.o ${RECAST_DEMO_SOURCE}/Sample.cpp
	g++ $(CXXFLAGS) -c ${ALL_INCS} -o ${OBJDIR}/SoloMesh.o ${RECAST_DEMO_SOURCE}/SoloMesh.cpp
	gcc $(CFLAGS) -c -o ${OBJDIR}/fastlz.o ${RECAST_DEMO_SOURCE}/fastlz.c
	g++ $(CXXFLAGS) -c ${ALL_INCS} -o ${OBJDIR}/Sample_TempObstacles.o ${RECAST_DEMO_SOURCE}/Sample_TempObstacles.cpp
	ar -rcs $(TARGETLIB)/libRecastDemoBis.a ${OBJDIR}/ChunkyTriMesh.o ${OBJDIR}/MeshLoaderObj.o ${OBJDIR}/InputGeom.o ${OBJDIR}/SoloMesh.o ${OBJDIR}/Sample.o ${OBJDIR}/fastlz.o ${OBJDIR}/Sample_TempObstacles.o